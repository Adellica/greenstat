<!DOCTYPE html>
<html>
  <head>
    <style>
     #map {
         height: 100%;
     }
     html, body, #map-wrapper {
         height: 100%;
         margin: 0;
         padding: 0;
     }
     #map-overlay { position: absolute; top: 10px; left: 10px; z-index: 99; }
    </style>
    <script>
     window.createAtom = function(initial) {
         var value = initial;
         var listeners = {};
         var getset = function (newValue) {
             if(typeof newValue !== 'undefined') {
                 var oldValue = value;
                 if(oldValue == newValue) {
                     return; // avoid unecessary listener calls
                 }
                 value = newValue;
                 for(var key in listeners) {
                     (listeners[key])(newValue, oldValue);
                 }
             }
             return value;
         };
         getset.listener = function(key, fnc) {
             listeners[key] = fnc;
             (listeners[key])(value, value);
         }
         return getset;
     };

     var createFloatInputAtom = function(id, value) {
         var Atom = createAtom(value);
         Atom.listener('#' + id, function(nv, ov) {
             var el = document.getElementById(id);
             if(el) {
                 el.value = nv;
             }
             else {
                 console.error('cannot find element', id);
             }
         });
         document.getElementById(id).addEventListener('change', function(evt) {
             if(evt && evt.target) {
                 Atom(parseFloat(evt.target.value));
             }
         });
         return Atom;
     };


     // helper for directions
     // result from service.route(...);
     function routeDistance(result) {
        var total = 0;
        var myroute = result.routes[0];
        for (var i = 0; i < myroute.legs.length; i++) {
          total += myroute.legs[i].distance.value;
        }
        return total / 1000;
      }
    </script>
  </head>

  <body>
    <div id="map-wrapper">
      <div id="map"></div>
      <div id="map-overlay">
        <style>
         input , img {
             width: 128px;
         }
         table > tbody > tr > td {
             font-family: monospace;
             text-align: right;
             background-color: #ffffff80;
             padding: 4px;
         }
         .place , .distance {
             width: 230px;
             font-family: mono;
             font-size: 8pt;
         }
         .distance {
             width: 60px;
             text-align: right;
         }
        </style>
        <div style="margin-bottom: 10px;">
          <a href="greenstat.no">
            <img src="greenstat-hvit.png"  />
          </a>
        </div>

        <div>A
          <input type="text" class="place"    id="pac-A" />
          <span>km:</span>
        </div>

        <div>B
          <input type="text" class="place"    id="pac-B" />
          <input type="text" class="distance" id="distanceAB">
        </div>

        <div>C
          <input type="text" class="place"    id="pac-C" />
          <input type="text" class="distance" id="distanceAC">
        </div>

        <div>Salgspris (kr H₂)</div>
        <div>
          <input type="text" class="distance" id="saleprice" />
        </div>
        <div>Transkost (kr/km)</div>
        <div>
          <input type="text" class="distance" id="transcost" />
        </div>

        <table>
          <tbody>
            <tr><th>Last</th><th>kr/kg</th></tr>
            <tr><td> 500</td><td id="prpkg500"></td><td id="kp500"></td></tr>
            <tr><td>1000</td><td id="prpkg1000"></td><td id="kp1000"></td></tr>
            <tr><td>1500</td><td id="prpkg1500"></td><td id="kp1500"></td></tr>
            <tr><td>2000</td><td id="prpkg2000"></td><td id="kp2000"></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>

     Saleprice = createFloatInputAtom('saleprice', 20); // NOK H₂
     Transcost = createFloatInputAtom('transcost', 20);
     DistanceAB = createFloatInputAtom('distanceAB', 20);
     DistanceAC = createFloatInputAtom('distanceAC', 20);

     function updateTable() {
         console.log('updating table against',
                     'Transcost', Transcost(),
                     'Distance', DistanceAB());
         var dists = [500, 1000, 1500, 2000];
         dists.forEach(function(dist) {
             var id = 'prpkg' + dist;
             var el = document.getElementById(id);
             if(el) {
                 el.innerHTML = ((Transcost() * DistanceAB()) / dist).toFixed(2);
             } else {
                 console.error('cannot find element #' + id);
             }

             el = document.getElementById('kp' + dist);
             if(el) {
                 el.innerHTML = (((Transcost() * DistanceAB()) / dist) + Saleprice()).toFixed(2);
             } else {
                 console.error('cannot find element #' + id);
             }
         });
     }

     Saleprice.listener('table', updateTable);
     Transcost.listener('table', updateTable);
     DistanceAB.listener('table', updateTable);
     updateTable();

     function initMap() {

         var A = createAtom(new google.maps.LatLng({lat: 66.8180072, lng: 13.95109176})); // Glomfjord
         var B = createAtom(new google.maps.LatLng({lat: 66.9881091, lng: 14.18609619})); // Bodø lufthavn
         var C = createAtom(new google.maps.LatLng({lat: 66.3154486, lng: 14.15313720})); // Flostrand

         var map = new google.maps.Map(document.getElementById('map'), {
             zoom: 7,
             center: A(),
             mapTypeId: 'roadmap',
             scaleControl: true,
             mapTypeControl: false, // leave room for our map-overlay
             clickableIcons: false, // remove "landmark" click popup
         });

         var markerAtom = function(Atom, label) {
             var marker = new google.maps.Marker({
                 map: map,
                 draggable: true,
                 label: label,
                 position: Atom(),
             });
             marker.addListener('dragend', function() {
                 Atom(marker.getPosition());
             });
             Atom.listener('marker', function(nv, ov) {
                 marker.setPosition(Atom());
             });
             return marker;
         }
         var markerA = markerAtom(A, 'A');
         var markerB = markerAtom(B, 'B');
         var markerC = markerAtom(C, 'C');

         var service = new google.maps.DirectionsService;

         var makeRouter = function(Distance, From, To) {
             var display = new google.maps.DirectionsRenderer({
                 draggable: true,
                 map: map,
                 preserveViewport: true,
                 suppressMarkers: true,
             });
             display.addListener('directions_changed', function() {
                 console.log('updating distance: ', Distance(), 'from directions', display.getDirections());
                 var directions = display.getDirections();
                 var start = directions.routes[0].legs[0].start_location;
                 //A(start);
                 Distance(routeDistance(display.getDirections()));
             });

             return function() {
                 service.route({
                     origin: From(),
                     destination: To(),
                     travelMode: 'DRIVING',
                     avoidTolls: false, // TODO parameterize this
                 }, function(response, status) {
                     if (status === 'OK') {
                         //console.log('service.route response=', response);
                         display.setDirections(response);
                     } else if(status === 'ZERO_RESULTS') {
                         console.error('no route found between', From(), To());
                     } else {
                         console.error('Could not display directions due to ', status);
                     }
                 });
             };
         }
         var routeAB = makeRouter(DistanceAB, A, B);
         var routeAC = makeRouter(DistanceAC, A, C);
         C.listener('routeAC', routeAC);
         B.listener('routeAB', routeAB);
         A.listener('routeAB', routeAB);
         A.listener('routeAC', routeAC);

         var createAutocomplete = function(id, Atom) {
             var pac = document.getElementById(id);
             var autocomplete = new google.maps.places.Autocomplete(pac);
             autocomplete.addListener('place_changed', function() {
                 var place = autocomplete.getPlace();
                 if(place && place.geometry && place.geometry.location) {
                     Atom(place.geometry.location);
                 } else {
                     console.error('no geometry.location for', place);
                 }
             });
             Atom.listener('#' + id, function(nv, ov) {
                 // document.getElementById(id).value = nv;
             });
         };
         createAutocomplete('pac-A', A);
         createAutocomplete('pac-B', B);
         createAutocomplete('pac-C', C);

         // export for poor man's repl
         window.map = map;
         window.A = A;
         window.B = B;
         window.C = C;
         window.service = service;
     }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc4r-qzNh9XGAOCrljj2sZokV8G3Y1naA&callback=initMap&libraries=places">
    </script>
  </body>
</html>
