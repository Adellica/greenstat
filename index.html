<!DOCTYPE html>
<html>
  <head>
    <style>
     #map {
         height: 100%;
     }
     html, body, #map-wrapper {
         height: 100%;
         margin: 0;
         padding: 0;
     }
     #map-overlay { position: absolute; top: 10px; left: 10px; z-index: 99; }
    </style>
    <script>
     window.createAtom = function(initial) {
         var value = initial;
         var listeners = {};
         var getset = function (newValue) {
             if(typeof newValue !== 'undefined') {
                 var oldValue = value;
                 value = newValue;
                 for(var key in listeners) {
                     (listeners[key])(oldValue, newValue);
                 }
             }
             return value;
         };
         getset.listener = function(key, fnc) {
             listeners[key] = fnc;
             (listeners[key])(value, value);
         }
         return getset;
     };

     // helper for directions
     // result from service.route(...);
     function routeDistance(result) {
        var total = 0;
        var myroute = result.routes[0];
        for (var i = 0; i < myroute.legs.length; i++) {
          total += myroute.legs[i].distance.value;
        }
        return total / 1000;
      }
    </script>
  </head>

  <body>
    <div id="map-wrapper">
      <div id="map"></div>
      <div id="map-overlay">
        <style>
         input , img {
             width: 128px;
         }
         table > tbody > tr > td {
             font-family: monospace;
             text-align: right;
             background-color: #ffffff80;
             padding: 4px;
         }
        </style>
        <div style="margin-bottom: 10px;">
          <a href="greenstat.no">
            <img src="greenstat-hvit.png"  />
          </a>
        </div>
        <div>Prodkost (kr/kg H₂)</div>
        <div>
          <input type="text" style="width: 128px;" id="prodcost" />
        </div>
        <div>Transkost (kr/km H₂)</div>
        <div>
          <input type="text" style="width: 128px;" id="transcost" />
        </div>
        <div>Strekningslengde (km):
          <div>
            <input type="text" id="distance">
          </div>
        </div>
        <table>
          <tbody>
            <tr><th>Last</th><th>kr/kg</th></tr>
            <tr><td> 500</td><td id="prpkg500"></td></tr>
            <tr><td>1000</td><td id="prpkg1000"></td></tr>
            <tr><td>1500</td><td id="prpkg1500"></td></tr>
            <tr><td>2000</td><td id="prpkg2000"></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>

     Prodcost = createAtom(20); // NOK/kg
     Prodcost.listener('#prodcost', function(ol, nw) {
         document.getElementById('prodcost').value = nw;
     });
     document.getElementById('prodcost')
             .addEventListener('change', function(x) {
                 console.log('updating Prodcost', x);
                 Prodcost(parseFloat(x.target.value));
             });

     Transcost = createAtom(20); // NOK/km
     Transcost.listener('#transcost', function(ol, nw) {
         document.getElementById('transcost').value = nw;
     });
     document.getElementById('transcost')
             .addEventListener('change', function(x) {
                 console.log('updating Transcost', x);
                 Transcost(parseFloat(x.target.value));
             });

     Distance = createAtom('');
     Distance.listener('#distance', function(ol, nw) {
         document.getElementById('distance').value = (typeof nw === 'number') ? Math.round(nw) : nw;
     });
     document.getElementById('distance')
             .addEventListener('change', function(x) {
                 console.log('updating Distance', x);
                 Distance(x.target.value);
             });

     function updateTable() {
         console.log('updating table against',
                     'Prodcost', Prodcost(),
                     'Transcost', Transcost(),
                     'Distance', Distance());
         var dists = [500, 1000, 1500, 2000];
         dists.forEach(function(dist) {
             var id = 'prpkg' + dist;
             var el = document.getElementById(id);
             if(el) {
                 el.innerHTML = ((Prodcost() * Transcost() * Distance()) / dist).toFixed(2);
             } else {
                 console.error('cannot find element #' + id);
             }
         });
     }

     Prodcost.listener('table', updateTable);
     Transcost.listener('table', updateTable);
     Distance.listener('table', updateTable);
     updateTable();

     function initMap() {

         var origin = new google.maps.LatLng({lat: 66.818007299, lng: 13.9510917663}); // Glomfjord
         var dest   = new google.maps.LatLng({lat: 66.988109162, lng: 14.1860961914}); // Bodø lufthavn

         var map = new google.maps.Map(document.getElementById('map'), {
             zoom: 7,
             center: origin,
             mapTypeId: 'roadmap',
             scaleControl: true,
             mapTypeControl: false, // leave room for our map-overlay
             clickableIcons: false, // remove "landmark" click popup
         });

         var service = new google.maps.DirectionsService;
         var display = new google.maps.DirectionsRenderer({
             draggable: true,
             map: map,
             preserveViewport: true,
         });
         display.addListener('directions_changed', function() {
             Distance(routeDistance(display.getDirections()));
             console.log('updating distance: ', Distance());
         });
         function doRoute(origin, dest) {
             service.route({
                 origin: origin,
                 destination: dest,
                 travelMode: 'DRIVING',
                 avoidTolls: false, // TODO parameterize this
             }, function(response, status) {
                 if (status === 'OK') {
                     console.log(response);
                     display.setDirections(response);
                 } else if(status === 'ZERO_RESULTS') {
                     console.error('no route found between', origin, dest);
                 } else {
                     console.error('Could not display directions due to ', status);
                 }
             });
         }
         doRoute(origin, dest);

         map.addListener('click', function(evt) {
             dest.lat = evt.latLng.lat;
             dest.lng = evt.latLng.lng;
             console.log('clicked map', 'from', origin, 'to', dest);
             doRoute(origin, dest);
         });

         // export for poor man's repl
         window.map = map;
         window.origin = origin;
         window.dest = dest;
         window.service = service;
         window.display = display;
     }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc4r-qzNh9XGAOCrljj2sZokV8G3Y1naA&callback=initMap">
    </script>
  </body>
</html>
